#!/bin/bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
mask="$script_dir/mask.png"
if [[ ! -f "$mask" ]]; then
  echo "mask.png missing from $script_dir"
  exit 1
fi

shopt -s nullglob
cd "$script_dir" || { echo "cd to $script_dir failed"; exit 1; }

for img in *.png; do
  if [[ "$img" == "mask.png" ]]; then
    continue
  fi
  tmpfile="$(mktemp --tmpdir="$script_dir" --suffix=.png)"
  ffmpeg -y -i "$img" -i "$mask" -filter_complex "[0][1]alphamerge,format=rgba,lut=a='if(gte(val,0.01),val,0)'" -c:v png "$tmpfile"
  if [[ $? -eq 0 ]]; then
    mv "$tmpfile" "$img"
  else
    echo "$img failed"
    rm "$tmpfile"
  fi
done
